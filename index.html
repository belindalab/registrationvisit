<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ó–∞–ø–∏—Å—å –≤–∏–∑–∏—Ç–∞ ‚Ä¢ Belinda.tj</title>
  
<style>
    :root {
      --accent: #DB3C21;
      --primary: #DB3C21;
      --primary-dark: #c63520;
      --primary-light: #fef2f2;
      --secondary: #10b981;
      --secondary-dark: #059669;
      --surface: #ffffff;
      --surface-2: #f6f7fb;
      --surface-3: #e6e9f0;
      --text: #1a1a1a;
      --text-secondary: #555;
      --text-muted: #94a3b8;
      --error: #dc2626;
      --warning: #f59e0b;
      --success: #16a34a;
      --border: #e6e9f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius: 12px;
      --radius-lg: 16px;
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--surface-2);
      min-height: 100vh;
      padding: 16px;
      color: var(--text);
      font-size: 16px;
      line-height: 1.6;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header {
      text-align: center;
      color: var(--text);
      margin-bottom: 16px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--primary);
    }

    .header p {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 400;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      border: 1px solid var(--border);
      position: relative;
    }

    .form-group {
      position: relative;
      margin-bottom: 24px;
    }

    .form-group.compact {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 500;
      background: var(--surface);
      color: var(--text);
      transition: var(--transition);
      appearance: none;
      position: relative;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(219, 60, 33, 0.1);
      transform: translateY(-1px);
    }

    .form-input.with-suggestions:focus {
      border-radius: var(--radius) var(--radius) 0 0;
      border-bottom-color: var(--border);
    }

    .form-select {
      background-image: url("data:image/svg+xml;charset=utf-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23374151' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 16px center;
      background-repeat: no-repeat;
      background-size: 20px;
      padding-right: 48px;
      cursor: pointer;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .form-input[readonly] {
      background: var(--surface-2);
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .location-section {
      background: var(--surface-2);
      border-radius: var(--radius);
      padding: 20px;
      border: 2px dashed var(--border);
      text-align: center;
      transition: var(--transition);
    }

    .location-section.active {
      border-color: var(--secondary);
      background: rgba(16, 185, 129, 0.05);
    }

    .location-section.loading {
      border-color: var(--accent);
      background: rgba(245, 158, 11, 0.05);
    }

    .location-icon {
      width: 48px;
      height: 48px;
      background: var(--primary-light);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      transition: var(--transition);
    }

    .location-section.active .location-icon {
      background: rgba(16, 185, 129, 0.1);
      color: var(--secondary);
    }

    .location-section.loading .location-icon {
      background: rgba(245, 158, 11, 0.1);
      color: var(--accent);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .location-text {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .location-coords {
      font-size: 12px;
      color: var(--text-muted);
      font-family: 'SFMono-Regular', Consolas, monospace;
    }

    .btn {
      width: 100%;
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn.secondary {
      background: var(--surface-2);
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn.secondary:hover {
      background: var(--surface-3);
      border-color: var(--primary);
    }

    .status {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .status.success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--secondary-dark);
      border: 1px solid rgba(16, 185, 129, 0.2);
      display: block;
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.2);
      display: block;
    }

    .status.info {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary-dark);
      border: 1px solid rgba(37, 99, 235, 0.2);
      display: block;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .location-btn {
      background: none;
      border: none;
      width: 100%;
      height: 100%;
      cursor: pointer;
      padding: 0;
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 640px) {
      body {
        padding: 8px;
        background: var(--surface);
      }

      .container {
        gap: 12px;
        max-width: 100%;
      }

      .header {
        margin-bottom: 12px;
      }

      .header h1 {
        font-size: 20px;
      }

      .header p {
        font-size: 13px;
      }

      .card {
        padding: 16px;
        border-radius: var(--radius);
        box-shadow: none;
        border: 1px solid var(--border);
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-input, .form-select, .form-textarea {
        padding: 12px 14px;
        font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç zoom –Ω–∞ iOS */
        border-radius: var(--radius);
      }

      .btn {
        padding: 14px 20px;
        font-size: 15px;
      }

      .location-section {
        padding: 16px;
      }

      .location-icon {
        width: 40px;
        height: 40px;
      }
    }

    /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ–º */
    @media (prefers-color-scheme: dark) {
      :root {
        --surface: #1e293b;
        --surface-2: #334155;
        --surface-3: #475569;
        --text: #f1f5f9;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border: #475569;
      }
    }

    /* –ü–æ–∏—Å–∫–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
    .prov-suggestions {
      background: var(--surface);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      max-height: 200px;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: var(--transition);
      font-size: 14px;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover {
      background: var(--surface-2);
    }

    .suggestion-item.selected {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 500;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    .form-group {
      opacity: 0;
      animation: slideUpFade 0.4s ease-out forwards;
    }

    .form-group:nth-child(1) { animation-delay: 0.1s; }
    .form-group:nth-child(2) { animation-delay: 0.2s; }
    .form-group:nth-child(3) { animation-delay: 0.3s; }
    .form-group:nth-child(4) { animation-delay: 0.4s; }
    .form-group:nth-child(5) { animation-delay: 0.5s; }

    @keyframes slideUpFade {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
</style>
</head>

<body>
  <div class="container">
    <div class="header">
    <h1>–ó–∞–ø–∏—Å—å –≤–∏–∑–∏—Ç–∞</h1>
      <p>–¢–æ—Ä–≥–æ–≤—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å</p>
    </div>

    <div class="card">
      <div class="form-group">
        <label class="form-label">–¢–æ—Ä–≥–æ–≤—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å</label>
        <select id="tp" class="form-select">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¢–ü...</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">–ü—Ä–æ–≤–∏–∑–æ—Ä</label>
        <input type="text" id="provSearch" class="form-input" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è –ø—Ä–æ–≤–∏–∑–æ—Ä–∞...">
        <div class="prov-suggestions" id="provSuggestions" style="display: none;"></div>
        <input type="hidden" id="prov" value="">
        <input type="hidden" id="pharmacy" value="">
    </div>

      <div class="form-group">
        <label class="form-label">–ê–ø—Ç–µ–∫–∞</label>
        <input id="pharmacyDisplay" type="text" class="form-input" readonly placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è">
    </div>

      <div class="form-group">
        <label class="form-label">–ù–∞–ª–∏—á–∏–µ –∑–∞—è–≤–∫–∏</label>
        <select id="order" class="form-select">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
          <option value="yes">‚úÖ –ï—Å—Ç—å –∑–∞—è–≤–∫–∞</option>
          <option value="no">‚ùå –ù–µ—Ç –∑–∞—è–≤–∫–∏</option>
      </select>
    </div>

      <div class="form-group">
        <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –≤–∏–∑–∏—Ç—É</label>
        <textarea id="comment" class="form-textarea" placeholder="–û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –≤–∏–∑–∏—Ç–∞, –æ–±—Å—É–∂–¥—ë–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã..."></textarea>
    </div>

      <div class="form-group">
        <label class="form-label">–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</label>
        <div id="locationSection" class="location-section">
          <button type="button" class="location-btn" id="geoBtn">
            <div class="location-icon" id="locationIcon">üìç</div>
            <div class="location-text" id="locationText">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è</div>
            <div class="location-coords" id="geoInfo"></div>
          </button>
        </div>
    </div>

      <button class="btn" id="saveBtn" disabled>
        <span id="saveText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–∑–∏—Ç</span>
      </button>

    <div class="status" id="status"></div>
    </div>
  </div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwhRgFloBMo1CXm_0QS7EmTUN5fEsDJtIxJ7rilbeHgncZ2N-7SETwNevqZQPJfzp7Q/exec";

    let state = {
      lat: null,
      lng: null,
      provList: [],
      isLoading: false
    };

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const elements = {
      tp: document.getElementById("tp"),
      prov: document.getElementById("prov"),
      provSearch: document.getElementById("provSearch"),
      provSuggestions: document.getElementById("provSuggestions"),
      pharmacy: document.getElementById("pharmacy"),
      pharmacyDisplay: document.getElementById("pharmacyDisplay"),
      order: document.getElementById("order"),
      comment: document.getElementById("comment"),
      geoBtn: document.getElementById("geoBtn"),
      geoInfo: document.getElementById("geoInfo"),
      locationSection: document.getElementById("locationSection"),
      locationIcon: document.getElementById("locationIcon"),
      locationText: document.getElementById("locationText"),
      saveBtn: document.getElementById("saveBtn"),
      saveText: document.getElementById("saveText"),
      status: document.getElementById("status")
    };

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
    function showStatus(message, type = 'info') {
      const status = elements.status;
      status.className = `status ${type}`;
      status.innerHTML = message;
      status.style.display = 'block';

      if (type === 'success') {
        setTimeout(() => {
          status.style.display = 'none';
        }, 4000);
      }
    }

    // –°–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—É—Å
    function hideStatus() {
      elements.status.style.display = 'none';
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    function updateSaveButton() {
      const isValid = elements.tp.value && elements.prov.value && state.lat && state.lng;
      elements.saveBtn.disabled = !isValid || state.isLoading;
    }

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤ –¢–ü –∏ –ø—Ä–æ–≤–∏–∑–æ—Ä–æ–≤
    async function loadLists() {
      try {
        showStatus('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...', 'info');
        
    const [tp, prov] = await Promise.all([
          fetch(WEBAPP_URL + "?action=tpList").then(r => r.json()),
          fetch(WEBAPP_URL + "?action=provList").then(r => r.json())
        ]);

        if (!tp.ok) throw new Error(tp.error || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –¢–ü");
        if (!prov.ok) throw new Error(prov.error || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–≤–∏–∑–æ—Ä–æ–≤");

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¢–ü
        elements.tp.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¢–ü...</option>';
        tp.list.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          elements.tp.appendChild(option);
        });

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–∏–∑–æ—Ä–æ–≤
        state.provList = prov.list;
        initProviderSearch();

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–º—è –¢–ü
        loadSavedTPName();

        hideStatus();
        showStatus('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');

      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
        showStatus(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}`, 'error');
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localStorage
    function saveTPName(tpName) {
      localStorage.setItem('visitApp_tpName', tpName);
    }

    function loadSavedTPName() {
      const savedTP = localStorage.getItem('visitApp_tpName');
      if (savedTP && elements.tp.querySelector(`option[value="${savedTP}"]`)) {
        elements.tp.value = savedTP;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–≤–∏–∑–æ—Ä–æ–≤
    function initProviderSearch() {
      const searchInput = elements.provSearch;
      const suggestionsDiv = elements.provSuggestions;
      
      let selectedIndex = -1;
      let currentSuggestions = [];

      // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏
      function showSuggestions(query) {
        if (!query) {
          hideSuggestions();
          return;
        }

        currentSuggestions = state.provList.filter(p => 
          p.name.toLowerCase().includes(query.toLowerCase())
        );

        if (currentSuggestions.length === 0) {
          hideSuggestions();
          return;
        }

        suggestionsDiv.innerHTML = '';
        currentSuggestions.forEach((prov, index) => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          item.textContent = prov.name;
          item.addEventListener('click', () => selectProvider(prov));
          suggestionsDiv.appendChild(item);
        });

        suggestionsDiv.style.display = 'block';
        searchInput.classList.add('with-suggestions');
        selectedIndex = -1;
      }

      // –°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏
      function hideSuggestions() {
        suggestionsDiv.style.display = 'none';
        searchInput.classList.remove('with-suggestions');
        selectedIndex = -1;
      }

      // –í—ã–±–æ—Ä –ø—Ä–æ–≤–∏–∑–æ—Ä–∞
      function selectProvider(prov) {
        elements.prov.value = prov.name;
        elements.provSearch.value = prov.name;
        elements.pharmacy.value = prov.pharmacy;
        elements.pharmacyDisplay.value = prov.pharmacy;
        hideSuggestions();
        updateSaveButton();
      }

      // –ü–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        
        if (query.length >= 1) {
          showSuggestions(query);
        } else {
          hideSuggestions();
        }

        // –°–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∏–∑–æ—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—è
        if (elements.prov.value && elements.prov.value !== query) {
          elements.prov.value = '';
          elements.pharmacy.value = '';
          elements.pharmacyDisplay.value = '';
          updateSaveButton();
        }
      });

      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
      searchInput.addEventListener('keydown', (e) => {
        const suggestions = suggestionsDiv.querySelectorAll('.suggestion-item');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
          updateSelection(suggestions);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelection(suggestions);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          selectProvider(currentSuggestions[selectedIndex]);
        } else if (e.key === 'Escape') {
          hideSuggestions();
        }
      });

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
      function updateSelection(suggestions) {
        suggestions.forEach((item, index) => {
          item.classList.toggle('selected', index === selectedIndex);
        });
      }

      // –°–∫—Ä—ã—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
          hideSuggestions();
        }
      });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏
    [elements.order].forEach(el => {
      el.addEventListener('change', updateSaveButton);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –¢–ü —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    elements.tp.addEventListener('change', (e) => {
      if (e.target.value) {
        saveTPName(e.target.value);
      }
      updateSaveButton();
    });

// –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
    function getLocation() {
      if (!navigator.geolocation) {
        showStatus('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º', 'error');
        return;
      }

      // –û–±–Ω–æ–≤–∏—Ç—å UI
      elements.locationSection.classList.add('loading');
      elements.locationIcon.textContent = '‚è≥';
      elements.locationText.textContent = '–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...';
      elements.geoInfo.textContent = '';

      navigator.geolocation.getCurrentPosition(
        position => {
          state.lat = +position.coords.latitude.toFixed(6);
          state.lng = +position.coords.longitude.toFixed(6);

          // –û–±–Ω–æ–≤–∏—Ç—å UI
          elements.locationSection.classList.remove('loading');
          elements.locationSection.classList.add('active');
          elements.locationIcon.textContent = '‚úÖ';
          elements.locationText.textContent = '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
          elements.geoInfo.textContent = `${state.lat}, ${state.lng}`;

          updateSaveButton();
          showStatus('üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ', 'success');
        },
        error => {
          elements.locationSection.classList.remove('loading');
          elements.locationIcon.textContent = '‚ùå';
          elements.locationText.textContent = '–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è';
          elements.geoInfo.textContent = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏';

          let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
          switch (error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
              break;
            case error.TIMEOUT:
              errorMessage = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ';
              break;
          }
          
          showStatus(`‚ùå ${errorMessage}`, 'error');
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    elements.geoBtn.addEventListener('click', getLocation);

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∏–∑–∏—Ç–∞
    elements.saveBtn.addEventListener('click', async () => {
      if (state.isLoading) return;

  const payload = {
        tp: elements.tp.value,
        prov: elements.prov.value,
        pharmacy: elements.pharmacy.value,
        hasOrder: elements.order.value === "yes",
        comment: elements.comment.value.trim(),
        lat: state.lat,
        lng: state.lng
      };

      hideStatus();

      // –í–∞–ª–∏–¥–∞—Ü–∏—è
      if (!payload.tp) return showStatus('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è', 'error');
      if (!payload.prov) return showStatus('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≤–∏–∑–æ—Ä–∞', 'error');
      if (!payload.lat || !payload.lng) return showStatus('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'error');

      try {
        state.isLoading = true;
        updateSaveButton();
        
        elements.saveText.innerHTML = '<span class="loading-spinner"></span>–°–æ—Ö—Ä–∞–Ω—è–µ–º...';

const form = new URLSearchParams({
  action: 'save',
  payload: JSON.stringify(payload)
});

const res = await fetch(WEBAPP_URL, {
  method: "POST",
  headers: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" },
  body: form.toString()
}).then(r => r.json());

        if (res && res.ok) {
          showStatus(`üéâ –í–∏–∑–∏—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ! ID: #${res.index}`, 'success');
          
          // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã (–∫—Ä–æ–º–µ –¢–ü)
          elements.prov.value = "";
          elements.provSearch.value = "";
          elements.pharmacy.value = "";
          elements.pharmacyDisplay.value = "";
          elements.order.value = "";
          elements.comment.value = "";
          
          // –°–±—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
      state.lat = state.lng = null;
          elements.locationSection.classList.remove('active');
          elements.locationIcon.textContent = 'üìç';
          elements.locationText.textContent = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è';
          elements.geoInfo.textContent = '';
          
    } else {
          throw new Error(res && res.error ? res.error : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }

      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
        showStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${err.message}`, 'error');
      } finally {
        state.isLoading = false;
        elements.saveText.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–∑–∏—Ç';
        updateSaveButton();
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
loadLists();
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏
    window.addEventListener('offline', () => {
      showStatus('‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É', 'error');
    });

    window.addEventListener('online', () => {
      showStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
    });
</script>
</body>
</html>
